================================================================================
HOSTED AGENT IMPLEMENTATION PLAN
================================================================================

Version: 1.0 - Safe Operations Only
LLM Provider: OpenAI GPT-4
Security: Encrypted API keys (Option A)
History: Database storage
Permissions: Read + Create only (no delete/update)

================================================================================
PHASE 1: DATABASE SCHEMA & ENCRYPTION (Day 1)
================================================================================

Task 1.1: Add Encrypted Key Support to api_keys Table
────────────────────────────────────────────────────────────────────────────

File: supabase/migrations/add_encrypted_agent_keys.sql

```sql
-- Add encrypted_key column for agent keys (server-side decryption only)
ALTER TABLE api_keys ADD COLUMN encrypted_key TEXT;

-- Add index for agent keys
CREATE INDEX idx_api_keys_agent ON api_keys(organization_id, name)
WHERE name = 'Hosted Agent (Auto-generated)';
```

Task 1.2: Create Conversation Storage Tables
────────────────────────────────────────────────────────────────────────────

File: supabase/migrations/create_agent_conversations.sql

```sql
-- Agent conversations table
CREATE TABLE agent_conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  title TEXT, -- Auto-generated from first message
  started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_message_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  status TEXT DEFAULT 'active', -- active, archived
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Agent messages table
CREATE TABLE agent_messages (
  id BIGSERIAL PRIMARY KEY,
  conversation_id UUID NOT NULL REFERENCES agent_conversations(id) ON DELETE CASCADE,
  role TEXT NOT NULL, -- user, assistant, system
  content TEXT NOT NULL,
  tool_calls JSONB, -- Array of tool calls made by assistant
  tool_results JSONB, -- Results returned from tool execution
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- RLS Policies for agent_conversations
ALTER TABLE agent_conversations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their org's conversations" ON agent_conversations
  FOR SELECT USING (
    user_id = auth.uid() OR
    organization_id IN (
      SELECT organization_id FROM organization_members
      WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Users can create conversations in their org" ON agent_conversations
  FOR INSERT WITH CHECK (
    user_id = auth.uid() AND
    organization_id IN (
      SELECT organization_id FROM organization_members
      WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Users can update their own conversations" ON agent_conversations
  FOR UPDATE USING (user_id = auth.uid());

-- RLS Policies for agent_messages
ALTER TABLE agent_messages ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view messages in their conversations" ON agent_messages
  FOR SELECT USING (
    conversation_id IN (
      SELECT id FROM agent_conversations
      WHERE user_id = auth.uid() OR
      organization_id IN (
        SELECT organization_id FROM organization_members
        WHERE user_id = auth.uid()
      )
    )
  );

CREATE POLICY "Users can create messages in their conversations" ON agent_messages
  FOR INSERT WITH CHECK (
    conversation_id IN (
      SELECT id FROM agent_conversations
      WHERE user_id = auth.uid()
    )
  );

-- Indexes
CREATE INDEX idx_conversations_user ON agent_conversations(user_id);
CREATE INDEX idx_conversations_org ON agent_conversations(organization_id);
CREATE INDEX idx_conversations_status ON agent_conversations(status) WHERE status = 'active';
CREATE INDEX idx_messages_conversation ON agent_messages(conversation_id);
CREATE INDEX idx_messages_created ON agent_messages(created_at DESC);
```

Task 1.3: Create Encryption Utilities
────────────────────────────────────────────────────────────────────────────

File: lib/encryption.ts (new file)

See full implementation in plan - includes:
- encrypt(plaintext: string): string
- decrypt(encryptedData: string): string
- generateEncryptionKey(): string
- Uses AES-256-GCM with auth tags

Environment variable required:
API_KEY_ENCRYPTION_SECRET=<64_hex_characters>

Generate with:
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

Task 1.4: Update Agent API Key Management
────────────────────────────────────────────────────────────────────────────

File: lib/agent-api-keys.ts (update existing)

Add function:
- getOrCreateHostedAgentApiKey(organizationId: string): Promise<string>
  - Checks for existing encrypted agent key
  - Decrypts and returns if exists
  - Creates new key if not exists
  - Encrypts and stores with encrypted_key column
  - Returns plain text key (server-side only)

================================================================================
PHASE 2: OPENAI INTEGRATION & TOOL DEFINITIONS (Day 2)
================================================================================

Task 2.1: Install OpenAI SDK
────────────────────────────────────────────────────────────────────────────

npm install openai

Environment variable:
OPENAI_API_KEY=sk-...

Task 2.2: Create OpenAI Client with Function Calling
────────────────────────────────────────────────────────────────────────────

File: lib/ai/openai-client.ts (new file)

Functions:
- callOpenAI(options: ChatOptions): Promise<string>
  - Handles function calling with tools
  - Multi-turn conversations
  - Executes tool calls via callback
  - Returns final response

Uses GPT-4-turbo-preview model

Task 2.3: Define Safe Agent Tools (Read + Create Only)
────────────────────────────────────────────────────────────────────────────

File: lib/ai/agent-tools.ts (new file)

11 Tools Total:

CAMPAIGN TOOLS (3):
- list_campaigns - List all campaigns with filters
- get_campaign - Get campaign details by ID
- create_campaign - Create new campaign (with budget validation)

ASSET TOOLS (2):
- list_assets - List all assets with filters
- get_asset - Get asset details by ID

AUDIENCE TOOLS (2):
- list_audiences - List all audiences with filters
- get_audience - Get audience details by ID

ASSIGNMENT TOOLS (2):
- assign_asset_to_campaign - Assign asset to campaign
- assign_audience_to_campaign - Assign audience to campaign

BUDGET TOOLS (1):
- get_budget_status - Get budget utilization

NOT INCLUDED (Restricted):
❌ update_campaign
❌ delete_campaign
❌ update_audience
❌ delete_audience
❌ delete_asset

Functions:
- getAllowedToolNames(): string[]
- isToolAllowed(toolName: string): boolean

================================================================================
PHASE 3: CHAT BACKEND API (Day 3)
================================================================================

Task 3.1: Create Tool Executor
────────────────────────────────────────────────────────────────────────────

File: lib/ai/tool-executor.ts (new file)

Function:
- executeAgentTool(toolName, args, context): Promise<unknown>
  - Maps tool names to Agent API endpoints
  - Builds HTTP requests with API key (server-side)
  - Calls Agent API
  - Returns results
  - All execution server-side (API key never leaves backend)

Context includes:
- apiKey (encrypted in DB, decrypted server-side)
- organizationId
- userId
- baseUrl

Task 3.2: Create Chat API Route
────────────────────────────────────────────────────────────────────────────

File: app/api/agent/chat/route.ts (new file)

POST /api/agent/chat

Flow:
1. Authenticate user via Supabase session (cookies)
2. Get user's organization
3. Get/create organization's encrypted agent API key (server-side)
4. Parse message from request
5. Get or create conversation
6. Save user message to database
7. Fetch conversation history (last 20 messages)
8. Build message array with system prompt
9. Call OpenAI with tools
10. Execute tool calls server-side when requested
11. Save assistant response
12. Update conversation timestamp
13. Return response to client

Security:
✅ API key retrieved and decrypted server-side only
✅ API key used in tool executor (server-side)
✅ OpenAI never receives API key
✅ User authenticated via standard session
✅ Rate limiting and budget validation automatic

================================================================================
PHASE 4: CHAT UI COMPONENT (Day 4)
================================================================================

Task 4.1: Create Agent Chat Widget
────────────────────────────────────────────────────────────────────────────

File: components/agent-chat-widget.tsx (new file)

Features:
- Message history display
- User/assistant message bubbles
- Loading indicators
- Auto-scroll to latest message
- Input field with send button
- Keyboard shortcuts (Enter to send)
- Empty state with suggestions
- Error handling
- Conversation persistence

Security:
✅ No API keys in client code
✅ Session authentication via cookies
✅ Standard fetch with credentials: 'include'

Task 4.2: Create Agent Chat Page
────────────────────────────────────────────────────────────────────────────

File: app/agent-chat/page.tsx (new file)

Simple page wrapper:
- Navigation component
- Agent chat widget
- Metadata for SEO

Task 4.3: Update Navigation
────────────────────────────────────────────────────────────────────────────

File: components/navigation.tsx (update)

Add link:
- Name: "Campaign Agent"
- Icon: Bot (from lucide-react)
- Href: /agent-chat

================================================================================
PHASE 5: TESTING & DOCUMENTATION (Day 5)
================================================================================

Task 5.1: Manual Testing Checklist
────────────────────────────────────────────────────────────────────────────

Authentication & Setup:
□ User must be logged in to access agent chat
□ Encryption key generated and added to .env.local
□ OpenAI API key added to .env.local
□ Agent API key auto-created on first chat

Basic Chat:
□ Send message and receive response
□ Conversation history persists
□ New conversation created automatically
□ Messages saved to database

Campaign Operations:
□ List existing campaigns
□ Get campaign details
□ Create new campaign (with budget check)
□ Budget exceeded error handled gracefully

Asset & Audience Operations:
□ List assets
□ List audiences
□ Assign asset to campaign
□ Assign audience to campaign

Security:
□ API key never visible in client/network
□ API key encrypted in database
□ Tool calls logged in audit log
□ Rate limiting still enforced

Restrictions:
□ Agent refuses to update campaigns
□ Agent refuses to delete campaigns
□ Agent explains restrictions politely

Task 5.2: Create Documentation
────────────────────────────────────────────────────────────────────────────

File: docs/HOSTED_AGENT_GUIDE.md (new file)

Contents:
- Overview and security architecture
- Setup instructions
- Supported vs restricted operations
- Example conversations
- Troubleshooting guide
- Monitoring instructions

Task 5.3: Update ClaudeLog.txt
────────────────────────────────────────────────────────────────────────────

Document:
- Implementation completed
- Files created/modified
- Testing results
- Known limitations

================================================================================
DELIVERABLES CHECKLIST
================================================================================

Phase 1: Database & Encryption
□ Migration: add_encrypted_agent_keys.sql
□ Migration: create_agent_conversations.sql
□ File: lib/encryption.ts
□ Update: lib/agent-api-keys.ts (add getOrCreateHostedAgentApiKey)
□ Environment: API_KEY_ENCRYPTION_SECRET added to .env.local

Phase 2: OpenAI Integration
□ Package: openai installed
□ File: lib/ai/openai-client.ts
□ File: lib/ai/agent-tools.ts (11 tools defined)
□ Environment: OPENAI_API_KEY added to .env.local

Phase 3: Chat Backend
□ File: lib/ai/tool-executor.ts
□ File: app/api/agent/chat/route.ts
□ Test: Chat API returns responses

Phase 4: Chat UI
□ File: components/agent-chat-widget.tsx
□ File: app/agent-chat/page.tsx
□ Update: components/navigation.tsx (add agent link)

Phase 5: Testing & Docs
□ Manual testing completed
□ File: docs/HOSTED_AGENT_GUIDE.md
□ Update: ClaudeLog.txt

================================================================================
SUCCESS CRITERIA
================================================================================

1. ✅ User can chat with agent without seeing API keys
2. ✅ Agent can list campaigns, assets, audiences
3. ✅ Agent can create new campaigns with budget validation
4. ✅ Agent can assign assets/audiences to campaigns
5. ✅ Agent refuses update/delete operations gracefully
6. ✅ All tool calls logged in audit log
7. ✅ Conversation history persists across sessions
8. ✅ API keys encrypted in database
9. ✅ Rate limiting and budget validation still enforced
10. ✅ No security vulnerabilities (keys never leak)

================================================================================
TIMELINE
================================================================================

Day 1: Phase 1 (Database & Encryption) - 4 hours
Day 2: Phase 2 (OpenAI Integration) - 4 hours
Day 3: Phase 3 (Chat Backend) - 6 hours
Day 4: Phase 4 (Chat UI) - 4 hours
Day 5: Phase 5 (Testing & Docs) - 2 hours

Total: ~20 hours (1 week part-time or 2.5 days full-time)

================================================================================
SECURITY ARCHITECTURE
================================================================================

┌─────────────────────────────────────────────────────────────────┐
│  USER (Browser)                                                  │
│  - Logged into Biddable via Supabase Auth                       │
│  - Has session cookie (httpOnly, secure)                        │
└────────────────────────┬────────────────────────────────────────┘
                         │ HTTPS + Session Cookie
                         │ POST /api/agent/chat
                         │ Body: { message: "..." }
                         │
┌────────────────────────▼────────────────────────────────────────┐
│  CHAT API BACKEND (Next.js Route Handler)                       │
│  /app/api/agent/chat/route.ts                                   │
│                                                                  │
│  1. Verify Supabase session (cookie auth)                       │
│  2. Extract user_id + organization_id                           │
│  3. Get org's encrypted API key from DB                         │
│  4. Decrypt API key (server-side only)                          │
│  5. Call OpenAI with tool definitions                           │
│  6. When OpenAI requests tool, execute server-side              │
│  7. Pass result to OpenAI, get response                         │
│  8. Return to user                                              │
│                                                                  │
│  ⚠️ API KEY NEVER LEAVES THIS LAYER ⚠️                          │
└────────────────────────┬────────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
        ▼                ▼                ▼
┌───────────────┐ ┌──────────────┐ ┌─────────────────┐
│ OpenAI        │ │  Agent API   │ │   Database      │
│ (GPT-4)       │ │  (Internal)  │ │   (Supabase)    │
│               │ │              │ │                 │
│ Gets:         │ │ Gets:        │ │ Stores:         │
│ - User msg    │ │ - API key    │ │ - Encrypted keys│
│ - Tool defs   │ │ - Auth header│ │ - Conversations │
│ - Tool results│ │ - Full access│ │ - Messages      │
│               │ │              │ │                 │
│ Never gets:   │ │              │ │                 │
│ ❌ API key    │ │              │ │                 │
│ ❌ User token │ │              │ │                 │
└───────────────┘ └──────────────┘ └─────────────────┘

================================================================================
END OF IMPLEMENTATION PLAN
================================================================================
